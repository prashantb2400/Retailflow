<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RetailFlow â€” Smart Invoicing</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Sora:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#F6F3EE;--surf:#FFF;--surf2:#EDEAE3;--bor:#DDD8CF;
  --tx:#1C1915;--tx2:#7A746C;--acc:#BF4A2B;--acc2:#E07A5F;
  --grn:#2B6E4A;--gnb:#E8F4EE;--ylw:#9A6D1E;--ylb:#FBF4E4;
  --red:#BF4A2B;--rdb:#FAEDEA;--blu:#2655A0;--blb:#EAF0FB;
  --sh:0 2px 8px rgba(0,0,0,.06),0 8px 24px rgba(0,0,0,.05);
  --shlg:0 12px 40px rgba(0,0,0,.12);
  --r:13px;--ff:'Sora',sans-serif;--ffd:'Playfair Display',serif;
}
[data-dark]{
  --bg:#131110;--surf:#1D1A17;--surf2:#232019;--bor:#302C27;
  --tx:#F0EDE6;--tx2:#9A948C;--acc:#E07A5F;--acc2:#BF4A2B;
  --gnb:#152618;--ylb:#221B0C;--rdb:#261511;--blb:#111B2B;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--ff);background:var(--bg);color:var(--tx);min-height:100vh;transition:background .25s,color .25s}
button,input,select,textarea{font-family:var(--ff)}
.topbar{position:sticky;top:0;z-index:99;height:58px;background:var(--surf);border-bottom:1px solid var(--bor);display:flex;align-items:center;justify-content:space-between;padding:0 20px;gap:10px}
.logo{font-family:var(--ffd);font-size:20px;color:var(--acc);letter-spacing:-.4px;white-space:nowrap;flex-shrink:0}
.logo b{color:var(--tx)}
.mtog{display:flex;background:var(--surf2);border:1.5px solid var(--bor);border-radius:9px;padding:3px;gap:2px}
.mbtn{border:none;background:transparent;padding:5px 14px;border-radius:7px;font-size:12px;font-weight:500;color:var(--tx2);transition:all .18s;white-space:nowrap;cursor:pointer}
.mbtn.on{background:var(--acc);color:#fff}
.tbr{display:flex;align-items:center;gap:8px;flex-shrink:0}
.wrap{max-width:1060px;margin:0 auto;padding:26px 18px}
.card{background:var(--surf);border:1.5px solid var(--bor);border-radius:var(--r);box-shadow:var(--sh);padding:22px}
.ctitle{font-family:var(--ffd);font-size:18px;margin-bottom:17px;color:var(--tx)}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:13px}
@media(max-width:680px){.g2,.g3,.g4{grid-template-columns:1fr 1fr}}
@media(max-width:420px){.g2,.g3{grid-template-columns:1fr}}
.fld{display:flex;flex-direction:column;gap:5px;margin-bottom:14px}
.fld label{font-size:11px;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.55px}
.fld input,.fld select,.fld textarea{padding:9px 13px;border:1.5px solid var(--bor);border-radius:8px;background:var(--surf2);color:var(--tx);font-size:13px;outline:none;transition:border .18s,box-shadow .18s;width:100%}
.fld input:focus,.fld select:focus,.fld textarea:focus{border-color:var(--acc);box-shadow:0 0 0 3px rgba(191,74,43,.12)}
.fld textarea{resize:vertical}
.btn{display:inline-flex;align-items:center;gap:7px;padding:9px 18px;border-radius:9px;border:none;font-size:13px;font-weight:500;transition:all .18s;cursor:pointer}
.btn:disabled{opacity:.45;cursor:not-allowed;pointer-events:none}
.bpri{background:var(--acc);color:#fff}.bpri:hover{background:var(--acc2);transform:translateY(-1px)}
.bgho{background:transparent;color:var(--tx2);border:1.5px solid var(--bor)}.bgho:hover{background:var(--surf2);color:var(--tx)}
.bdng{background:var(--rdb);color:var(--red);border:1.5px solid transparent}.bdng:hover{background:var(--red);color:#fff}
.bwa{background:#25D366;color:#fff;border:none}.bwa:hover{background:#1fb558}
.bsm{padding:5px 10px;font-size:11px;border-radius:7px}
.wfull{width:100%;justify-content:center}
.ibtn{width:34px;height:34px;border-radius:8px;border:1.5px solid var(--bor);background:var(--surf2);display:flex;align-items:center;justify-content:center;font-size:15px;transition:all .18s;cursor:pointer}
.ibtn:hover{background:var(--bor)}
.bdg{display:inline-flex;align-items:center;padding:2px 9px;border-radius:20px;font-size:10px;font-weight:600}
.bc{background:var(--rdb);color:var(--red)}.bca{background:var(--gnb);color:var(--grn)}
.bu{background:var(--blb);color:var(--blu)}.bch{background:var(--ylb);color:var(--ylw)}.bp{background:var(--gnb);color:var(--grn)}
.bcnt{background:var(--acc);color:#fff;border-radius:20px;padding:1px 7px;font-size:10px;margin-left:2px}
.tabs{display:flex;border-bottom:1.5px solid var(--bor);margin-bottom:20px;gap:2px;overflow-x:auto}
.tab{border:none;background:transparent;padding:9px 17px;font-size:13px;font-weight:500;color:var(--tx2);border-bottom:2px solid transparent;margin-bottom:-1.5px;transition:all .18s;white-space:nowrap;cursor:pointer}
.tab.on{color:var(--acc);border-bottom-color:var(--acc)}
.twrap{overflow-x:auto;border-radius:9px;border:1.5px solid var(--bor)}
table{width:100%;border-collapse:collapse}
th{padding:9px 13px;text-align:left;font-size:10px;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.5px;background:var(--surf2);border-bottom:1.5px solid var(--bor)}
td{padding:11px 13px;font-size:12px;border-bottom:1px solid var(--bor)}
tr:last-child td{border-bottom:none}
tr:hover td{background:var(--surf2)}
.sc{background:var(--surf);border:1.5px solid var(--bor);border-radius:var(--r);padding:16px 18px;box-shadow:var(--sh)}
.sl{font-size:10px;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
.sv{font-family:var(--ffd);font-size:23px;color:var(--tx)}
.ss{font-size:11px;color:var(--tx2);margin-top:3px}
.trow{display:flex;gap:7px;flex-wrap:wrap}
.tag{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:500;border:1.5px solid var(--bor);background:var(--surf2);color:var(--tx2);transition:all .18s;cursor:pointer}
.tag.on{background:var(--acc);color:#fff;border-color:var(--acc)}
.sh{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;gap:12px}
.st{font-family:var(--ffd);font-size:25px;color:var(--tx)}
.sb{font-size:13px;color:var(--tx2);margin-top:3px}
hr{border:none;border-top:1.5px solid var(--bor);margin:16px 0}
.frow{display:flex;gap:7px;margin-bottom:14px;flex-wrap:wrap}
.fbtn{padding:5px 12px;border-radius:20px;border:1.5px solid var(--bor);background:var(--surf2);color:var(--tx2);font-size:11px;font-weight:500;cursor:pointer;transition:all .18s}
.fbtn.on{background:var(--acc);color:#fff;border-color:var(--acc)}
.it{width:100%;border-collapse:collapse;margin:10px 0}
.it th{font-size:10px;font-weight:600;color:var(--tx2);text-transform:uppercase;padding:6px 8px;border-bottom:1.5px solid var(--bor);background:transparent;letter-spacing:.4px}
.it td{padding:5px 6px;font-size:12px;border:none}
.iinput{width:100%;padding:7px 9px;border:1.5px solid var(--bor);border-radius:7px;background:var(--surf2);color:var(--tx);font-size:12px;outline:none;font-family:var(--ff)}
.iinput:focus{border-color:var(--acc)}
.mover{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:200;display:flex;align-items:center;justify-content:center;padding:20px}
.modal{background:var(--surf);border-radius:18px;padding:26px;width:100%;max-width:480px;box-shadow:var(--shlg)}
.mtit{font-family:var(--ffd);font-size:20px;margin-bottom:13px}
.rmtxt{background:var(--surf2);border:1.5px solid var(--bor);border-radius:9px;padding:14px;font-size:13px;line-height:1.75;color:var(--tx);white-space:pre-wrap;max-height:220px;overflow-y:auto}
.alert{padding:10px 14px;border-radius:9px;font-size:13px;margin-bottom:14px}
.aerr{background:var(--rdb);color:var(--red)}.aok{background:var(--gnb);color:var(--grn)}
.awrn{background:var(--ylb);color:var(--ylw)}
.cwrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:32px 18px;background:var(--bg)}
.ccard{background:var(--surf);border:1.5px solid var(--bor);border-radius:20px;padding:36px;width:100%;max-width:440px;box-shadow:var(--shlg)}
.biglogo{font-family:var(--ffd);font-size:32px;color:var(--acc);margin-bottom:5px}
.asub{font-size:13px;color:var(--tx2);margin-bottom:26px}
.empty{text-align:center;padding:50px 20px;color:var(--tx2)}
.eico{font-size:42px;margin-bottom:10px}.etit{font-size:15px;font-weight:500;color:var(--tx);margin-bottom:5px}
.row{display:flex;align-items:center;gap:8px}
.jbet{justify-content:space-between}
.mb14{margin-bottom:14px}.mt14{margin-top:14px}.mt18{margin-top:18px}
.tx2{color:var(--tx2)}.txacc{color:var(--acc)}.txgrn{color:var(--grn)}.txred{color:var(--red)}
.fw6{font-weight:600}.fs11{font-size:11px}.fs12{font-size:12px}.fs13{font-size:13px}
.lsnotice{background:var(--gnb);border:1.5px solid #b8dfc8;border-radius:10px;padding:11px 14px;font-size:12px;color:#1f5c39;margin-bottom:18px;line-height:1.6}
</style>
</head>
<body>
<div id="app"></div>
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RetailFlow â€” localStorage version
   Works by just opening this file. No internet needed.
   Data saves in your browser automatically.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ STORAGE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const LS = {
  get:(k,d=[])=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):d; }catch{return d;} },
  set:(k,v)=>{ try{ localStorage.setItem(k,JSON.stringify(v)); }catch{} }
};

/* â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const S = {
  firm:     LS.get('rf_firm', null),
  customers:LS.get('rf_customers', []),
  invoices: LS.get('rf_invoices',  []),
  purchases:LS.get('rf_purchases', []),
  sales:    LS.get('rf_sales',     []),
  mode:'invoice', page:'main', tab:'create', bizTab:'dash',
  invFilter:'all', custFilter:'all',
  dark: LS.get('rf_dark', false),
  reminder:null, viewInv:null, _reminderMsg:'',
  invForm:null, pForm:null, sForm:null,
};

/* â”€â”€ SAVE STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const save = ()=>{
  LS.set('rf_firm',      S.firm);
  LS.set('rf_customers', S.customers);
  LS.set('rf_invoices',  S.invoices);
  LS.set('rf_purchases', S.purchases);
  LS.set('rf_sales',     S.sales);
  LS.set('rf_dark',      S.dark);
};

/* â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const $       = id => document.getElementById(id);
const uid     = () => Math.random().toString(36).slice(2,9);
const today   = () => new Date().toISOString().split('T')[0];
const fmt     = n  => 'â‚¹'+Number(n||0).toLocaleString('en-IN',{minimumFractionDigits:2});
const fmtDate = d  => d ? new Date(d+'T00:00:00').toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}) : 'â€”';
const esc     = s  => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const pb      = m  => ({cash:'bca',upi:'bu',credit:'bc',cheque:'bch',paid:'bp'})[m]||'';
const GST     = [0,5,12,18,28];

const blankInv = ()=>({customer_name:'',customer_phone:'',payment_method:S.firm?.payment_method||'cash',date:today(),gst_rate:S.firm?.gst_rate||18,items:[{id:uid(),name:'',qty:1,rate:''}]});
const blankP   = ()=>({supplier:'',item:'',amount:'',date:today(),status:'paid'});
const blankS   = ()=>({customer:'',amount:'',date:today(),payment_type:'cash'});

function setDark(v){
  S.dark=v; LS.set('rf_dark',v);
  v ? document.documentElement.setAttribute('data-dark','') : document.documentElement.removeAttribute('data-dark');
}

/* â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function render(){
  const app=$('app'); if(!app) return;
  if(S.dark) document.documentElement.setAttribute('data-dark','');

  if(!S.firm){ app.innerHTML=renderSetup(); return; }

  if(!S.invForm) S.invForm=blankInv();
  if(!S.pForm)   S.pForm=blankP();
  if(!S.sForm)   S.sForm=blankS();

  app.innerHTML = renderTopbar()+`<div class="wrap">`+renderMain()+`</div>`+(S.reminder?renderModal():'');

  if(S.mode==='invoice'&&S.tab==='create'&&S.page==='main'){ renderItemRows(); updateTotals(); }
}

/* â”€â”€ SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderSetup(){
  return `<div class="cwrap"><div class="ccard" style="max-width:520px">
    <div class="row jbet mb14">
      <div><div class="biglogo">RetailFlow</div>
      <div class="asub">Set up your business â€” takes 60 seconds</div></div>
      <button class="ibtn" onclick="toggleDark()">${S.dark?'â˜€ï¸':'ğŸŒ™'}</button>
    </div>
    <div class="lsnotice">âœ… <strong>Works offline.</strong> All data saves automatically in your browser. No internet or account needed.</div>
    <div class="fld"><label>Firm / Business Name *</label><input id="sf-nm" placeholder="e.g. Sharma General Store"></div>
    <div class="g2">
      <div class="fld"><label>GSTIN</label><input id="sf-gs" placeholder="22AAAAA0000A1Z5" maxlength="15" oninput="this.value=this.value.toUpperCase()"></div>
      <div class="fld"><label>Proprietor Name *</label><input id="sf-pr" placeholder="Your full name"></div>
    </div>
    <div class="fld"><label>Business Address *</label><textarea id="sf-ad" rows="2" placeholder="Shop no., Street, City, State â€” PIN"></textarea></div>
    <div class="g2">
      <div class="fld"><label>Default GST Rate</label>
        <select id="sf-gr">${GST.map(r=>`<option value="${r}"${r===18?' selected':''}>${r}% GST</option>`).join('')}</select>
      </div>
      <div class="fld"><label>Default Payment</label>
        <select id="sf-pm"><option value="cash">Cash</option><option value="upi">UPI</option><option value="credit">Credit</option></select>
      </div>
    </div>
    <button class="btn bpri wfull mt14" onclick="saveFirm()">ğŸš€ Start Using RetailFlow</button>
  </div></div>`;
}

window.saveFirm=()=>{
  const nm=$('sf-nm')?.value?.trim(), pr=$('sf-pr')?.value?.trim(), ad=$('sf-ad')?.value?.trim();
  if(!nm||!pr||!ad){ alert('Please fill all required fields (*)'); return; }
  S.firm={id:uid(),firm_name:nm,gstin:$('sf-gs')?.value?.trim()||'',address:ad,proprietor:pr,gst_rate:Number($('sf-gr')?.value||18),payment_method:$('sf-pm')?.value||'cash'};
  S.invForm=blankInv(); save(); render();
};

/* â”€â”€ TOPBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderTopbar(){
  const n=S.customers.length;
  return `<div class="topbar">
    <div class="row" style="gap:12px;min-width:0">
      <div class="logo">Retail<b>Flow</b></div>
      <div class="mtog">
        <button class="mbtn${S.mode==='invoice'?' on':''}" onclick="swMode('invoice')">ğŸ§¾ Invoice</button>
        <button class="mbtn${S.mode==='business'?' on':''}" onclick="swMode('business')">ğŸ’¼ Business</button>
      </div>
    </div>
    <div class="tbr">
      <button class="btn bgho bsm" onclick="swPage('customers')">ğŸ‘¥ Customers${n?`<span class="bcnt">${n}</span>`:''}</button>
      <button class="btn bgho bsm" style="max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" onclick="editFirm()">âš™ï¸ ${esc(S.firm.firm_name)}</button>
      <button class="ibtn" onclick="toggleDark()">${S.dark?'â˜€ï¸':'ğŸŒ™'}</button>
    </div>
  </div>`;
}

/* â”€â”€ MAIN ROUTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderMain(){
  if(S.page==='customers') return renderCustomers();
  if(S.mode==='invoice')   return renderInvoice();
  return renderBusiness();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INVOICE MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderInvoice(){
  return `<div class="sh">
    <div><div class="st">Invoices</div><div class="sb">Create &amp; manage customer invoices</div></div>
    <button class="btn bpri" onclick="newInv()">+ New Invoice</button>
  </div>
  <div class="tabs">
    <button class="tab${S.tab==='create'?' on':''}" onclick="swTab('create')">âœï¸ Create</button>
    <button class="tab${S.tab==='list'?' on':''}" onclick="swTab('list')">ğŸ“‹ List (${S.invoices.length})</button>
  </div>
  ${S.tab==='create'?renderInvCreate():renderInvList()}`;
}

function renderInvCreate(){
  const f=S.invForm;
  return `<div class="card">
    <div class="ctitle">ğŸ§¾ New Invoice</div>
    <div class="g2">
      <div class="fld"><label>Customer Name *</label><input id="ic-cn" placeholder="Customer name" value="${esc(f.customer_name)}"></div>
      <div class="fld"><label>Phone (for WhatsApp)</label><input id="ic-cp" placeholder="10-digit mobile" value="${esc(f.customer_phone)}"></div>
    </div>
    <div class="g3">
      <div class="fld"><label>Payment Method</label>
        <div class="trow">${['cash','credit','upi'].map(m=>`<button class="tag${f.payment_method===m?' on':''}" onclick="setIPM('${m}')">${m.toUpperCase()}</button>`).join('')}</div>
      </div>
      <div class="fld"><label>Date</label><input id="ic-dt" type="date" value="${f.date}"></div>
      <div class="fld"><label>GST Rate</label>
        <select id="ic-gr" onchange="setIGST(this.value)">${GST.map(r=>`<option value="${r}"${r===f.gst_rate?' selected':''}>${r}%</option>`).join('')}</select>
      </div>
    </div>
    <hr>
    <div class="fw6 fs13" style="margin-bottom:8px">Line Items</div>
    <table class="it">
      <thead><tr><th>Description</th><th style="width:62px">Qty</th><th style="width:105px">Rate â‚¹</th><th style="width:105px">Amount</th><th style="width:36px"></th></tr></thead>
      <tbody id="itbody"></tbody>
    </table>
    <button class="btn bgho bsm" style="margin-bottom:14px" onclick="addIItem()">+ Add Item</button>
    <div style="background:var(--surf2);border-radius:10px;padding:14px">
      <div class="row jbet fs12" style="margin-bottom:7px"><span class="tx2">Subtotal</span><span id="i-sub">â‚¹0.00</span></div>
      <div class="row jbet fs12" style="margin-bottom:7px"><span class="tx2" id="i-glbl">GST (${f.gst_rate}%)</span><span id="i-gst">â‚¹0.00</span></div>
      <hr style="margin:8px 0">
      <div class="row jbet" style="font-family:var(--ffd);font-size:19px"><span>Total</span><span class="txacc" id="i-tot">â‚¹0.00</span></div>
    </div>
    <div class="row mt18" style="justify-content:flex-end;gap:10px">
      <button class="btn bgho" onclick="clearInv()">Clear</button>
      <button class="btn bpri" onclick="saveInvoice()">ğŸ’¾ Save Invoice</button>
    </div>
  </div>`;
}

function renderInvList(){
  const invs=S.invFilter==='all'?S.invoices:S.invoices.filter(i=>i.payment_method===S.invFilter);
  return `
  ${S.viewInv?`<div class="card mb14">
    <div class="row jbet mb14">
      <span class="txgrn fw6 fs13">âœ… Saved â€” ${esc(S.viewInv.invoice_no)}</span>
      <div class="row" style="gap:8px">
        <button class="btn bpri bsm" onclick="doPrint('${S.viewInv.id}')">ğŸ–¨ï¸ Print / PDF</button>
        <button class="btn bgho bsm" onclick="dismissV()">Dismiss</button>
      </div>
    </div>
    ${invPreviewHTML(S.viewInv)}
  </div>`:''}
  <div class="frow">
    ${['all','cash','upi','credit'].map(f=>`<button class="fbtn${S.invFilter===f?' on':''}" onclick="setIF('${f}')">${f==='all'?'All':f.toUpperCase()}</button>`).join('')}
  </div>
  ${invs.length===0
    ?`<div class="empty"><div class="eico">ğŸ§¾</div><div class="etit">No invoices yet</div><div>Create your first above</div></div>`
    :`<div class="twrap"><table>
      <thead><tr><th>Invoice #</th><th>Customer</th><th>Date</th><th>Payment</th><th>Total</th><th>Actions</th></tr></thead>
      <tbody>${invs.map(inv=>`<tr>
        <td class="txacc fw6" style="cursor:pointer" onclick="viewI('${inv.id}')">${esc(inv.invoice_no)}</td>
        <td>${esc(inv.customer_name||'â€”')}</td>
        <td class="tx2">${fmtDate(inv.date)}</td>
        <td><span class="bdg ${pb(inv.payment_method)}">${inv.payment_method.toUpperCase()}</span></td>
        <td class="fw6">${fmt(inv.total)}</td>
        <td><div class="row" style="gap:5px">
          <button class="btn bgho bsm" onclick="doPrint('${inv.id}')">ğŸ–¨ï¸</button>
          <button class="btn bdng bsm" onclick="delInv('${inv.id}')">ğŸ—‘ï¸</button>
        </div></td>
      </tr>`).join('')}</tbody>
    </table></div>`}`;
}

function invPreviewHTML(inv){
  const f=S.firm;
  return `<div style="background:#fff;color:#1C1915;border:1.5px solid #DDD8CF;border-radius:13px;padding:22px;font-family:'Sora',sans-serif">
    <div class="row jbet mb14" style="align-items:flex-start">
      <div>
        <div style="font-family:'Playfair Display',serif;font-size:22px;color:#BF4A2B">${esc(f.firm_name)}</div>
        <div style="font-size:11px;color:#7A746C;margin-top:3px;line-height:1.65">Prop: ${esc(f.proprietor)}<br>${esc(f.address)}${f.gstin?`<br>GSTIN: ${esc(f.gstin)}`:''}</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700;font-size:15px">${esc(inv.invoice_no)}</div>
        <div style="font-size:11px;color:#7A746C;margin-top:3px">${fmtDate(inv.date)}</div>
        <span class="bdg ${pb(inv.payment_method)}" style="margin-top:5px;display:inline-block">${inv.payment_method.toUpperCase()}</span>
      </div>
    </div>
    <div style="background:#F6F3EE;border-radius:8px;padding:10px 14px;margin-bottom:14px">
      <div style="font-size:10px;font-weight:600;color:#7A746C;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px">Bill To</div>
      <div style="font-weight:600;font-size:14px">${esc(inv.customer_name||'Walk-in Customer')}</div>
      ${inv.customer_phone?`<div style="font-size:11px;color:#7A746C">ğŸ“ ${esc(inv.customer_phone)}</div>`:''}
    </div>
    <table style="width:100%;border-collapse:collapse">
      <thead><tr style="background:#BF4A2B">${['#','Description','Qty','Rate','Amount'].map(h=>`<th style="padding:6px 10px;text-align:left;color:#fff;font-size:10px;font-weight:600">${h}</th>`).join('')}</tr></thead>
      <tbody>${(inv.items||[]).map((it,i)=>`<tr style="background:${i%2===0?'#fff':'#FAF8F5'}">
        <td style="padding:6px 10px;font-size:11px;color:#7A746C">${i+1}</td>
        <td style="padding:6px 10px;font-size:12px">${esc(it.name)}</td>
        <td style="padding:6px 10px;font-size:12px">${it.qty}</td>
        <td style="padding:6px 10px;font-size:12px">${fmt(it.rate)}</td>
        <td style="padding:6px 10px;font-size:12px;font-weight:500">${fmt(it.qty*it.rate)}</td>
      </tr>`).join('')}</tbody>
    </table>
    <div style="display:flex;flex-direction:column;align-items:flex-end;margin-top:12px;gap:3px">
      <div style="font-size:11px;color:#7A746C">Subtotal: ${fmt(inv.subtotal)}</div>
      <div style="font-size:11px;color:#7A746C">GST (${inv.gst_rate}%): ${fmt(inv.gst_amount)}</div>
      <div style="background:#BF4A2B;color:#fff;padding:8px 16px;border-radius:8px;font-family:'Playfair Display',serif;font-size:16px;margin-top:5px">Total: ${fmt(inv.total)}</div>
    </div>
  </div>`;
}

/* â”€â”€ INVOICE ITEM ROWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderItemRows(){
  const tbody=$('itbody'); if(!tbody||!S.invForm) return;
  tbody.innerHTML=S.invForm.items.map(it=>`<tr>
    <td><input class="iinput" data-id="${it.id}" data-f="name" value="${esc(it.name)}" placeholder="Item description"></td>
    <td><input class="iinput" data-id="${it.id}" data-f="qty" type="number" min="1" value="${it.qty}"></td>
    <td><input class="iinput" data-id="${it.id}" data-f="rate" type="number" min="0" step="0.01" value="${it.rate}"></td>
    <td class="txacc fw6" id="ia-${it.id}">${fmt(it.qty*(it.rate||0))}</td>
    <td><button class="btn bdng bsm" style="padding:3px 7px" onclick="remIItem('${it.id}')">âœ•</button></td>
  </tr>`).join('');
  tbody.querySelectorAll('.iinput').forEach(inp=>{
    inp.addEventListener('input',e=>{
      const id=e.target.dataset.id,f=e.target.dataset.f;
      const item=S.invForm.items.find(i=>i.id===id);
      if(item){ item[f]=e.target.value; const el=$('ia-'+id); if(el) el.textContent=fmt(Number(item.qty)*Number(item.rate||0)); updateTotals(); }
    });
  });
}

function updateTotals(){
  if(!S.invForm) return;
  const sub=S.invForm.items.reduce((s,i)=>s+Number(i.qty)*Number(i.rate||0),0);
  const gst=sub*S.invForm.gst_rate/100,tot=sub+gst;
  const upd=(id,v)=>{const el=$(id);if(el)el.textContent=fmt(v);};
  upd('i-sub',sub); upd('i-gst',gst); upd('i-tot',tot);
  const gl=$('i-glbl'); if(gl) gl.textContent=`GST (${S.invForm.gst_rate}%)`;
}

function readInvInputs(){
  if(!S.invForm) return;
  S.invForm.customer_name=$('ic-cn')?.value||'';
  S.invForm.customer_phone=$('ic-cp')?.value||'';
  S.invForm.date=$('ic-dt')?.value||today();
}

/* â”€â”€ PRINT / PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function doPrint(id){
  const inv=S.invoices.find(i=>i.id===id); if(!inv) return;
  const f=S.firm;
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Sora:wght@400;500;600&display=swap');
    *{box-sizing:border-box;margin:0;padding:0}body{font-family:'Sora',sans-serif;padding:32px;color:#1C1915;max-width:700px;margin:0 auto}
    .h{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:22px;padding-bottom:16px;border-bottom:2px solid #BF4A2B}
    .fn{font-family:'Playfair Display',serif;font-size:24px;color:#BF4A2B}
    .ms{font-size:11px;color:#7A746C;margin-top:3px;line-height:1.65}
    .in{font-size:19px;font-weight:700}.im{font-size:11px;color:#7A746C;text-align:right;margin-top:3px;line-height:1.65}
    .bt{background:#F6F3EE;border-radius:8px;padding:11px 14px;margin-bottom:16px}
    .bl{font-size:10px;font-weight:600;color:#7A746C;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
    table{width:100%;border-collapse:collapse;margin-bottom:12px}
    th{background:#BF4A2B;color:#fff;padding:7px 11px;text-align:left;font-size:10px;font-weight:600;text-transform:uppercase}
    td{padding:7px 11px;font-size:12px;border-bottom:1px solid #EDE9E2}
    tr:nth-child(even) td{background:#FAF8F5}
    .tr{display:flex;flex-direction:column;align-items:flex-end;gap:3px;margin-top:8px}
    .tl{font-size:11px;color:#7A746C}
    .tt{background:#BF4A2B;color:#fff;padding:8px 16px;border-radius:8px;font-family:'Playfair Display',serif;font-size:16px;margin-top:5px}
    .fo{text-align:center;margin-top:26px;font-size:11px;color:#7A746C;border-top:1px solid #EDE9E2;padding-top:12px}
  </style></head><body>
  <div class="h">
    <div><div class="fn">${esc(f.firm_name)}</div>
    <div class="ms">Prop: ${esc(f.proprietor)}<br>${esc(f.address)}${f.gstin?`<br>GSTIN: ${esc(f.gstin)}`:''}</div></div>
    <div><div class="in" style="text-align:right">${esc(inv.invoice_no)}</div><div class="im">Date: ${fmtDate(inv.date)}<br>Payment: ${inv.payment_method.toUpperCase()}</div></div>
  </div>
  <div class="bt"><div class="bl">Bill To</div>
  <div style="font-weight:600;font-size:14px">${esc(inv.customer_name||'Walk-in Customer')}</div>
  ${inv.customer_phone?`<div style="font-size:11px;color:#7A746C">ğŸ“ ${esc(inv.customer_phone)}</div>`:''}</div>
  <table><thead><tr><th>#</th><th>Description</th><th>Qty</th><th>Rate</th><th>Amount</th></tr></thead>
  <tbody>${(inv.items||[]).map((it,i)=>`<tr><td>${i+1}</td><td>${esc(it.name)}</td><td>${it.qty}</td><td>${fmt(it.rate)}</td><td>${fmt(it.qty*it.rate)}</td></tr>`).join('')}</tbody></table>
  <div class="tr">
    <div class="tl">Subtotal: ${fmt(inv.subtotal)}</div>
    <div class="tl">GST (${inv.gst_rate}%): ${fmt(inv.gst_amount)}</div>
    <div class="tt">Total: ${fmt(inv.total)}</div>
  </div>
  <div class="fo">Thank you for your business! ğŸ™ â€” ${esc(f.firm_name)}</div>
  <script>window.onload=()=>{window.print()}<\/script>
  </body></html>`);
  w.document.close();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUSINESS MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderBusiness(){
  const tS=S.sales.reduce((a,i)=>a+Number(i.amount),0);
  const tP=S.purchases.reduce((a,i)=>a+Number(i.amount),0);
  const cC=S.customers.filter(c=>Number(c.outstanding)>0);
  const tC=cC.reduce((a,c)=>a+Number(c.outstanding),0);
  return `<div class="sh"><div><div class="st">Business Manager</div><div class="sb">Track purchases, sales &amp; credit dues</div></div></div>
  <div class="g4 mb14">
    <div class="sc"><div class="sl">Total Sales</div><div class="sv txacc">${fmt(tS)}</div><div class="ss">${S.sales.length} transactions</div></div>
    <div class="sc"><div class="sl">Total Purchases</div><div class="sv">${fmt(tP)}</div><div class="ss">${S.purchases.length} entries</div></div>
    <div class="sc"><div class="sl">Credit Outstanding</div><div class="sv txred">${fmt(tC)}</div><div class="ss">${cC.length} customers</div></div>
    <div class="sc"><div class="sl">Net Position</div><div class="sv" style="color:${tS-tP>=0?'var(--grn)':'var(--red)'}">${fmt(tS-tP)}</div><div class="ss">Sales âˆ’ Purchases</div></div>
  </div>
  <div class="tabs">
    ${[['dash','ğŸ“Š Dashboard'],['purchases',`ğŸ“¦ Purchases (${S.purchases.length})`],['sales',`ğŸ’° Sales (${S.sales.length})`],['credit',`ğŸ”” Credit (${cC.length})`]].map(([k,v])=>`<button class="tab${S.bizTab===k?' on':''}" onclick="swBiz('${k}')">${v}</button>`).join('')}
  </div>
  ${S.bizTab==='dash'?renderDash():S.bizTab==='purchases'?renderPurch():S.bizTab==='sales'?renderSalesTab():renderCredit(cC,tC)}`;
}

function renderDash(){
  return `<div class="g2">
    <div class="card"><div class="ctitle">ğŸ“¦ Recent Purchases</div>
      ${S.purchases.slice(0,5).length===0?`<div class="empty" style="padding:20px 0"><div class="eico">ğŸ“¦</div><div class="etit">No purchases yet</div></div>`:
        S.purchases.slice(0,5).map(p=>`<div class="row jbet" style="padding:9px 0;border-bottom:1px solid var(--bor)">
          <div><div class="fw6 fs13">${esc(p.supplier)}</div><div class="tx2 fs11">${esc(p.item||'â€”')} Â· ${fmtDate(p.date)}</div></div>
          <div style="text-align:right"><div class="fw6">${fmt(p.amount)}</div><span class="bdg ${pb(p.status)}">${p.status.toUpperCase()}</span></div>
        </div>`).join('')}
    </div>
    <div class="card"><div class="ctitle">ğŸ’° Recent Sales</div>
      ${S.sales.slice(0,5).length===0?`<div class="empty" style="padding:20px 0"><div class="eico">ğŸ’°</div><div class="etit">No sales yet</div></div>`:
        S.sales.slice(0,5).map(s=>`<div class="row jbet" style="padding:9px 0;border-bottom:1px solid var(--bor)">
          <div><div class="fw6 fs13">${esc(s.customer)}</div><div class="tx2 fs11">${fmtDate(s.date)}</div></div>
          <div style="text-align:right"><div class="fw6">${fmt(s.amount)}</div><span class="bdg ${pb(s.payment_type)}">${s.payment_type.toUpperCase()}</span></div>
        </div>`).join('')}
    </div>
  </div>`;
}

function renderPurch(){
  const pf=S.pForm;
  return `<div class="card mb14">
    <div class="ctitle">+ Add Purchase Entry</div>
    <div class="g2">
      <div class="fld"><label>Supplier *</label><input id="p-sp" value="${esc(pf.supplier)}" placeholder="Supplier / Vendor"></div>
      <div class="fld"><label>Item / Goods</label><input id="p-it" value="${esc(pf.item)}" placeholder="Description"></div>
    </div>
    <div class="g3">
      <div class="fld"><label>Amount (â‚¹) *</label><input id="p-am" type="number" value="${esc(pf.amount)}" placeholder="0"></div>
      <div class="fld"><label>Date</label><input id="p-dt" type="date" value="${pf.date}"></div>
      <div class="fld"><label>Status</label>
        <div class="trow">${['paid','credit','cheque'].map(m=>`<button class="tag${pf.status===m?' on':''}" onclick="setPSt('${m}')">${m.charAt(0).toUpperCase()+m.slice(1)}</button>`).join('')}</div>
      </div>
    </div>
    <button class="btn bpri" onclick="savePurch()">Add Purchase</button>
  </div>
  ${S.purchases.length===0?`<div class="empty"><div class="eico">ğŸ“¦</div><div class="etit">No purchase entries yet</div></div>`
  :`<div class="twrap"><table><thead><tr><th>Supplier</th><th>Item</th><th>Date</th><th>Status</th><th>Amount</th><th></th></tr></thead>
    <tbody>${S.purchases.map(p=>`<tr>
      <td class="fw6">${esc(p.supplier)}</td><td class="tx2">${esc(p.item||'â€”')}</td>
      <td class="tx2">${fmtDate(p.date)}</td>
      <td><span class="bdg ${pb(p.status)}">${p.status.toUpperCase()}</span></td>
      <td class="fw6">${fmt(p.amount)}</td>
      <td><button class="btn bdng bsm" onclick="delP('${p.id}')">ğŸ—‘ï¸</button></td>
    </tr>`).join('')}</tbody></table></div>`}`;
}

function renderSalesTab(){
  const sf=S.sForm;
  return `<div class="card mb14">
    <div class="ctitle">+ Log Sale</div>
    <div class="g2">
      <div class="fld"><label>Customer *</label><input id="s-cu" value="${esc(sf.customer)}" placeholder="Customer name"></div>
      <div class="fld"><label>Amount (â‚¹) *</label><input id="s-am" type="number" value="${esc(sf.amount)}" placeholder="0"></div>
    </div>
    <div class="g2">
      <div class="fld"><label>Date</label><input id="s-dt" type="date" value="${sf.date}"></div>
      <div class="fld"><label>Payment Type</label>
        <div class="trow">${['cash','upi','credit'].map(m=>`<button class="tag${sf.payment_type===m?' on':''}" onclick="setSPT('${m}')">${m.toUpperCase()}</button>`).join('')}</div>
      </div>
    </div>
    <button class="btn bpri" onclick="saveSale()">Log Sale</button>
  </div>
  ${S.sales.length===0?`<div class="empty"><div class="eico">ğŸ’°</div><div class="etit">No sales logged yet</div></div>`
  :`<div class="twrap"><table><thead><tr><th>Customer</th><th>Date</th><th>Payment</th><th>Amount</th><th></th></tr></thead>
    <tbody>${S.sales.map(s=>`<tr>
      <td class="fw6">${esc(s.customer)}</td><td class="tx2">${fmtDate(s.date)}</td>
      <td><span class="bdg ${pb(s.payment_type)}">${s.payment_type.toUpperCase()}</span></td>
      <td class="fw6">${fmt(s.amount)}</td>
      <td><button class="btn bdng bsm" onclick="delS('${s.id}')">ğŸ—‘ï¸</button></td>
    </tr>`).join('')}</tbody></table></div>`}`;
}

function renderCredit(cC,tC){
  return `${cC.length>0?`<div class="alert awrn">âš ï¸ <strong>${cC.length} customers</strong> owe a total of <strong>${fmt(tC)}</strong></div>`:''}
  ${cC.length===0?`<div class="empty"><div class="eico">âœ…</div><div class="etit">All dues settled!</div></div>`
  :`<div class="twrap"><table><thead><tr><th>Customer</th><th>Phone</th><th>Last Date</th><th>Outstanding</th><th>Actions</th></tr></thead>
    <tbody>${cC.map(c=>`<tr>
      <td class="fw6">${esc(c.name)}</td><td class="tx2">${esc(c.phone||'â€”')}</td>
      <td class="tx2">${fmtDate(c.last_date)}</td>
      <td class="fw6 txred">${fmt(c.outstanding)}</td>
      <td><div class="row" style="gap:6px">
        <button class="btn bgho bsm" onclick="openRem('${c.id}')">ğŸ“© Reminder</button>
        ${c.phone?`<button class="btn bwa bsm" onclick="quickWA('${c.id}')">ğŸ’¬ WA</button>`:''}
      </div></td>
    </tr>`).join('')}</tbody></table></div>`}`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CUSTOMERS PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderCustomers(){
  const fil=S.custFilter;
  const list=fil==='all'?S.customers:fil==='out'?S.customers.filter(c=>Number(c.outstanding)>0):S.customers.filter(c=>c.payment_method===fil);
  const tB=S.customers.reduce((a,c)=>a+Number(c.total_business||0),0);
  const tO=S.customers.reduce((a,c)=>a+Number(c.outstanding||0),0);
  return `<div class="sh">
    <div><div class="st">Customers</div><div class="sb">${S.customers.length} total Â· ${fmt(tB)} business Â· ${fmt(tO)} outstanding</div></div>
    <button class="btn bgho" onclick="swPage('main')">â† Back</button>
  </div>
  <div class="frow">
    ${[['all','All'],['cash','Cash'],['upi','UPI'],['credit','Credit'],['out','Outstanding']].map(([f,l])=>`<button class="fbtn${fil===f?' on':''}" onclick="setCF('${f}')">${l}</button>`).join('')}
  </div>
  ${list.length===0?`<div class="empty"><div class="eico">ğŸ‘¥</div><div class="etit">No customers found</div><div class="tx2">Added automatically when you create invoices or log sales</div></div>`
  :`<div class="twrap"><table>
    <thead><tr><th>Name</th><th>Phone</th><th>Payment</th><th>Total Business</th><th>Outstanding</th><th>Last Date</th><th></th></tr></thead>
    <tbody>${list.map(c=>`<tr>
      <td class="fw6">${esc(c.name)}</td><td class="tx2">${esc(c.phone||'â€”')}</td>
      <td><span class="bdg ${pb(c.payment_method)}">${(c.payment_method||'').toUpperCase()}</span></td>
      <td class="fw6">${fmt(c.total_business)}</td>
      <td class="fw6" style="color:${Number(c.outstanding)>0?'var(--red)':'var(--grn)'}">${Number(c.outstanding)>0?fmt(c.outstanding):'Settled âœ“'}</td>
      <td class="tx2">${fmtDate(c.last_date)}</td>
      <td><button class="btn bdng bsm" onclick="delCust('${c.id}')">ğŸ—‘ï¸</button></td>
    </tr>`).join('')}</tbody>
  </table></div>`}`;
}

/* â”€â”€ REMINDER MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderModal(){
  const c=S.reminder; if(!c) return '';
  const msg=`Dear ${c.name},\n\nThis is a gentle reminder from us.\n\nYou have an outstanding balance of ${fmt(c.outstanding)} as on ${fmtDate(today())}.\n\nKindly settle the amount at your earliest convenience.\n\nThank you for your continued business! ğŸ™`;
  S._reminderMsg=msg;
  return `<div class="mover" onclick="closeRem()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="mtit">ğŸ“© Reminder â€” ${esc(c.name)}</div>
      <div class="rmtxt">${esc(msg)}</div>
      <div class="row mt14" style="flex-wrap:wrap;gap:8px">
        ${c.phone?`<button class="btn bwa" onclick="sendWA('${c.id}')">ğŸ’¬ Send via WhatsApp</button>`:''}
        <button class="btn bgho" onclick="copyRem()">ğŸ“‹ Copy</button>
        <button class="btn bgho" onclick="closeRem()">Close</button>
      </div>
      ${!c.phone?`<div class="fs11 tx2 mt14">ğŸ’¡ Add phone number to enable WhatsApp.</div>`:''}
    </div>
  </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ALL ACTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.toggleDark  = ()=>{ setDark(!S.dark); render(); };
window.swMode      = m=>{ S.mode=m; S.page='main'; S.tab='create'; S.bizTab='dash'; render(); };
window.swPage      = p=>{ S.page=p; render(); };
window.swTab       = t=>{ S.tab=t; render(); };
window.swBiz       = t=>{ S.bizTab=t; render(); };
window.setIF       = f=>{ S.invFilter=f; render(); };
window.setCF       = f=>{ S.custFilter=f; render(); };
window.dismissV    = ()=>{ S.viewInv=null; render(); };
window.viewI       = id=>{ S.viewInv=S.invoices.find(i=>i.id===id)||null; render(); };
window.newInv      = ()=>{ S.invForm=blankInv(); S.viewInv=null; S.tab='create'; render(); };
window.clearInv    = ()=>{ S.invForm=blankInv(); render(); };
window.editFirm    = ()=>{ if(confirm('Edit firm details?')){ S.firm=null; save(); render(); } };
window.openRem     = id=>{ S.reminder=S.customers.find(c=>c.id===id)||null; render(); };
window.closeRem    = ()=>{ S.reminder=null; render(); };
window.copyRem     = ()=>{ navigator.clipboard.writeText(S._reminderMsg).then(()=>alert('Copied!')).catch(()=>{}); };
window.doPrint     = doPrint;
window.sendWA      = id=>{ const c=S.customers.find(x=>x.id===id); if(!c?.phone) return; const n=c.phone.replace(/\D/g,''); window.open(`https://wa.me/${n.startsWith('91')?n:'91'+n}?text=${encodeURIComponent(S._reminderMsg)}`,'_blank'); };
window.quickWA     = id=>{ const c=S.customers.find(x=>x.id===id); if(!c?.phone) return; const n=c.phone.replace(/\D/g,''); const msg=`Dear ${c.name}, you have an outstanding balance of ${fmt(c.outstanding)}. Kindly clear at your earliest. Thank you! ğŸ™`; window.open(`https://wa.me/${n.startsWith('91')?n:'91'+n}?text=${encodeURIComponent(msg)}`,'_blank'); };

window.setIPM  = m=>{ readInvInputs(); S.invForm={...S.invForm,payment_method:m}; render(); };
window.setIGST = v=>{ if(S.invForm){ S.invForm.gst_rate=Number(v); updateTotals(); } };
window.addIItem= ()=>{ readInvInputs(); S.invForm.items.push({id:uid(),name:'',qty:1,rate:''}); renderItemRows(); updateTotals(); };
window.remIItem= id=>{ readInvInputs(); S.invForm.items=S.invForm.items.filter(i=>i.id!==id); renderItemRows(); updateTotals(); };
window.setPSt  = s=>{ const sp=$('p-sp')?.value||'',it=$('p-it')?.value||'',am=$('p-am')?.value||'',dt=$('p-dt')?.value||today(); S.pForm={supplier:sp,item:it,amount:am,date:dt,status:s}; render(); };
window.setSPT  = t=>{ const cu=$('s-cu')?.value||'',am=$('s-am')?.value||'',dt=$('s-dt')?.value||today(); S.sForm={customer:cu,amount:am,date:dt,payment_type:t}; render(); };

/* â”€â”€ INVOICE SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window.saveInvoice=()=>{
  readInvInputs();
  const f=S.invForm;
  if(!f?.customer_name||f.items.every(i=>!i.name)){ alert('Add customer name and at least one item.'); return; }
  const sub=f.items.reduce((s,i)=>s+Number(i.qty)*Number(i.rate||0),0);
  const gstA=sub*f.gst_rate/100, tot=sub+gstA;
  const inv={id:uid(),invoice_no:`INV-${Date.now().toString().slice(-7)}`,customer_name:f.customer_name,customer_phone:f.customer_phone,payment_method:f.payment_method,date:f.date||today(),gst_rate:f.gst_rate,items:[...f.items],subtotal:sub,gst_amount:gstA,total:tot};
  S.invoices=[inv,...S.invoices];
  upsertCust(f.customer_name,f.customer_phone,f.payment_method,tot);
  S.viewInv=inv; S.invForm=blankInv(); S.tab='list'; save(); render();
};

window.delInv=id=>{ if(!confirm('Delete this invoice?')) return; S.invoices=S.invoices.filter(i=>i.id!==id); if(S.viewInv?.id===id) S.viewInv=null; save(); render(); };

/* â”€â”€ PURCHASE SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window.savePurch=()=>{
  const sup=$('p-sp')?.value?.trim(), amt=Number($('p-am')?.value);
  if(!sup||!amt){ alert('Fill supplier name and amount.'); return; }
  S.purchases=[{id:uid(),supplier:sup,item:$('p-it')?.value?.trim()||'',amount:amt,date:$('p-dt')?.value||today(),status:S.pForm?.status||'paid'},...S.purchases];
  S.pForm=blankP(); save(); render();
};
window.delP=id=>{ if(!confirm('Delete this entry?')) return; S.purchases=S.purchases.filter(p=>p.id!==id); save(); render(); };

/* â”€â”€ SALE SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window.saveSale=()=>{
  const cu=$('s-cu')?.value?.trim(), amt=Number($('s-am')?.value);
  if(!cu||!amt){ alert('Fill customer name and amount.'); return; }
  const pt=S.sForm?.payment_type||'cash';
  S.sales=[{id:uid(),customer:cu,amount:amt,date:$('s-dt')?.value||today(),payment_type:pt},...S.sales];
  upsertCust(cu,''  ,pt,amt);
  S.sForm=blankS(); save(); render();
};
window.delS=id=>{ if(!confirm('Delete this sale?')) return; S.sales=S.sales.filter(s=>s.id!==id); save(); render(); };

/* â”€â”€ CUSTOMER HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function upsertCust(name,phone,pay,amount){
  const ex=S.customers.find(c=>c.name.toLowerCase()===name.toLowerCase());
  if(ex){
    S.customers=S.customers.map(c=>c.name.toLowerCase()===name.toLowerCase()?{...c,total_business:(c.total_business||0)+amount,outstanding:(c.outstanding||0)+(pay==='credit'?amount:0),last_date:today(),payment_method:pay}:c);
  } else {
    S.customers=[...S.customers,{id:uid(),name,phone:phone||'',payment_method:pay,total_business:amount,outstanding:pay==='credit'?amount:0,last_date:today()}];
  }
}
window.delCust=id=>{ if(!confirm("Delete customer? Their invoices remain.")) return; S.customers=S.customers.filter(c=>c.id!==id); save(); render(); };

/* â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
if(S.dark) document.documentElement.setAttribute('data-dark','');
render();
</script>
</body>
</html>
